---
phase: 03-ai-content
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - js/ai.js
autonomous: true

must_haves:
  truths:
    - "Selecting a time period and category triggers a Gemini API call with GPS coordinates"
    - "Generated content displays in the content panel with proper formatting"
    - "Changing time period or category fetches and displays new content"
    - "A loading skeleton appears while content is being generated"
    - "Switching back to a previous combination shows cached content instantly"
    - "Content auto-fetches on first load with default Ancient + Archaeology"
  artifacts:
    - path: "js/ai.js"
      provides: "AI content service: Gemini API calls, event wiring, cache, debounce, panel control"
      min_lines: 80
  key_links:
    - from: "js/ai.js"
      to: "js/config.js"
      via: "reads GEO_CONFIG.GEMINI_API_KEY and GEO_CONFIG.GEMINI_ENDPOINT"
      pattern: "GEO_CONFIG"
    - from: "js/ai.js"
      to: "js/app.js"
      via: "reads window.geoState, listens for timePeriodChange and categoryChange events"
      pattern: "geoState|timePeriodChange|categoryChange"
    - from: "js/ai.js"
      to: "index.html"
      via: "manipulates #content-panel, #content-panel-title, #content-text, #content-loading, #content-panel-close DOM elements"
      pattern: "getElementById.*content"
---

<objective>
Create the AI content service that calls the Gemini API with the user's GPS + navigator selections and populates the content panel.

Purpose: This is the core intelligence of the app -- it makes the map come alive by generating location-aware historical/cultural content.
Output: js/ai.js containing fetch logic, debounced event handling, response caching, loading state management, and panel open/close behavior.
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-content/03-01-SUMMARY.md
@index.html
@js/app.js
@js/config.js
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI content service with Gemini API integration</name>
  <files>js/ai.js</files>
  <action>
Create `js/ai.js` as a self-executing IIFE (matching app.js pattern). The module must:

**1. DOM References:**
```js
var panel = document.getElementById('content-panel');
var panelTitle = document.getElementById('content-panel-title');
var panelText = document.getElementById('content-text');
var panelLoading = document.getElementById('content-loading');
var closeBtn = document.getElementById('content-panel-close');
```

**2. Cache object:**
```js
var contentCache = {}; // key: "timePeriod|category|lat|lng" -> value: {title, text}
```
Cache key uses rounded lat/lng (2 decimal places) so small GPS drift doesn't bust cache.

**3. Debounce utility:**
```js
var debounceTimer = null;
var DEBOUNCE_MS = 300;

function debouncedFetch() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(function () {
    fetchContent();
  }, DEBOUNCE_MS);
}
```

**4. Cache key builder:**
```js
function buildCacheKey() {
  var pos = window.geoState.position;
  var lat = pos ? pos.lat.toFixed(2) : '0';
  var lng = pos ? pos.lng.toFixed(2) : '0';
  return window.geoState.timePeriod + '|' + window.geoState.category + '|' + lat + '|' + lng;
}
```

**5. Panel control functions:**
```js
function openPanel() {
  panel.classList.add('content-panel--open');
}

function closePanel() {
  panel.classList.remove('content-panel--open');
}

function showLoading() {
  panelLoading.classList.remove('content-panel__loading--hidden');
  panelText.innerHTML = '';
}

function hideLoading() {
  panelLoading.classList.add('content-panel__loading--hidden');
}

function displayContent(title, text) {
  hideLoading();
  panelTitle.textContent = title;
  // Convert plain text paragraphs to HTML paragraphs
  panelText.innerHTML = text
    .split('\n\n')
    .filter(function (p) { return p.trim(); })
    .map(function (p) { return '<p>' + p.trim() + '</p>'; })
    .join('');
}
```

**6. Title builder:**
```js
function buildTitle() {
  var period = window.geoState.timePeriod;
  var category = window.geoState.category;
  // Capitalize first letter
  var cap = function (s) { return s.charAt(0).toUpperCase() + s.slice(1); };
  return cap(period) + ' ' + cap(category);
}
```

**7. Core fetch function:**
```js
function fetchContent() {
  var cacheKey = buildCacheKey();

  // Check cache first
  if (contentCache[cacheKey]) {
    displayContent(contentCache[cacheKey].title, contentCache[cacheKey].text);
    openPanel();
    return;
  }

  // Show loading state
  panelTitle.textContent = buildTitle();
  showLoading();
  openPanel();

  // Build position string
  var pos = window.geoState.position;
  var posStr = pos
    ? pos.lat.toFixed(4) + ', ' + pos.lng.toFixed(4)
    : '32.0853, 34.7818'; // fallback: Tel Aviv

  // Build prompt
  var prompt = 'You are a historical guide. The user is standing at [' + posStr + '] in Israel. ' +
    'Tell them about this location during the ' + window.geoState.timePeriod + ' era, ' +
    'focusing on ' + window.geoState.category + '. ' +
    'Be vivid, engaging, and educational. 2-3 paragraphs. ' +
    'Do not use markdown formatting, just plain text paragraphs separated by blank lines.';

  // Build request body
  var body = JSON.stringify({
    contents: [{
      parts: [{ text: prompt }]
    }]
  });

  var url = GEO_CONFIG.GEMINI_ENDPOINT + '?key=' + GEO_CONFIG.GEMINI_API_KEY;

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: body
  })
    .then(function (res) {
      if (!res.ok) throw new Error('API error: ' + res.status);
      return res.json();
    })
    .then(function (data) {
      // Extract text from Gemini response
      var text = '';
      try {
        text = data.candidates[0].content.parts[0].text;
      } catch (e) {
        text = 'Unable to parse AI response. Please try again.';
      }

      var title = buildTitle();

      // Cache the response
      contentCache[cacheKey] = { title: title, text: text };

      // Display
      displayContent(title, text);
    })
    .catch(function (err) {
      hideLoading();
      panelText.innerHTML = '<p style="color: var(--neon-magenta);">Could not load content. ' +
        'Check your API key in js/config.js.</p>' +
        '<p style="color: var(--text-secondary); font-size: 0.8rem;">' + err.message + '</p>';
    });
}
```

**8. Event listeners:**
```js
// Close button
closeBtn.addEventListener('click', closePanel);

// Navigator changes trigger content fetch (debounced)
document.addEventListener('timePeriodChange', debouncedFetch);
document.addEventListener('categoryChange', debouncedFetch);

// Auto-fetch on first load (small delay to let GPS settle)
setTimeout(function () {
  fetchContent();
}, 1000);
```

**IMPORTANT patterns to follow:**
- Wrap everything in an IIFE: `(function () { 'use strict'; ... })();`
- Use `var` not `let`/`const` (matching app.js ES5 style)
- Use `.then()` not `async/await` (ES5 compat)
- Error display inside the panel, not alert()
- The prompt explicitly asks for no markdown, just plain text paragraphs
  </action>
  <verify>
1. Open the app in browser with DevTools Network tab open
2. On load: after ~1 second, content panel should slide in with loading skeleton, then display AI-generated content about "Ancient Archaeology" for the user's location
3. Click a different time period (e.g., Medieval) — loading skeleton appears, new content fetches and displays
4. Click a different category (e.g., Nature) — same behavior
5. Switch back to Ancient + Archaeology — content appears instantly from cache (no network request)
6. Click the X button — panel closes
7. Rapidly click multiple time periods — only one API call fires (debounce working)
8. Check console for errors — none
  </verify>
  <done>
- Gemini API called with GPS + time period + category on every navigator change (AI-01, AI-03)
- Content displays in formatted paragraphs in the sliding panel (AI-02)
- Loading skeleton shown during API calls (AI-04)
- Responses cached by position + selection combo
- Panel auto-opens on first load
- Debounce prevents API spam on rapid clicks
- Error state displayed gracefully in panel
  </done>
</task>

</tasks>

<verification>
**Full Phase 3 Integration Test:**
1. Open app fresh — panel auto-slides in after 1s, shows loading skeleton, then Ancient Archaeology content
2. Switch to Medieval — panel shows loading, then medieval content
3. Switch to Nature category — panel shows loading, then medieval nature content
4. Switch back to Ancient + Archaeology — cached, instant display, no network call
5. Close panel with X — panel slides away
6. Switch to Ottoman — panel slides back in with new content
7. On mobile viewport (380px) — panel takes full width
8. Theme colors (panel border, title, scrollbar) match active time period theme
9. No console errors throughout
</verification>

<success_criteria>
- AI-01: GPS coordinates sent to Gemini API in prompt (verified via Network tab)
- AI-02: Content displays in readable panel with paragraph formatting
- AI-03: Changing time period or category triggers new content fetch
- AI-04: Loading skeleton visible during API response time
- Cache prevents duplicate API calls for same combo
- Debounce (300ms) prevents API spam
- Error handling shows user-friendly message in panel
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-content/03-02-SUMMARY.md`
</output>
