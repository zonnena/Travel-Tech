---
phase: 04-polish-social
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/app.js
  - js/social.js
  - css/style.css
  - index.html
autonomous: false

must_haves:
  truths:
    - "Simulated friend avatars appear on the map with names and gentle drifting movement"
    - "Ghost Mode toggle button hides all friend avatars when activated and shows them when deactivated"
    - "POI markers appear on the map near the user position for points of interest"
    - "Full app flow works on phone browser with no empty or broken states during demo"
  artifacts:
    - path: "js/social.js"
      provides: "Friend avatars, Ghost Mode, POI markers"
      min_lines: 80
    - path: "js/app.js"
      provides: "Exposed map instance via window.geoMap"
      contains: "window.geoMap"
    - path: "css/style.css"
      provides: "Styling for friend avatars, ghost mode toggle, POI markers"
      contains: "friend-marker"
    - path: "index.html"
      provides: "Ghost Mode toggle button in HTML, social.js script tag"
      contains: "ghost-mode"
  key_links:
    - from: "js/social.js"
      to: "window.geoMap"
      via: "Leaflet map reference for adding markers"
      pattern: "window\\.geoMap"
    - from: "js/social.js"
      to: "window.geoState"
      via: "Reading user position for placing friends/POIs nearby"
      pattern: "window\\.geoState\\.position"
    - from: "index.html"
      to: "js/social.js"
      via: "Script tag after app.js"
      pattern: "social\\.js"
---

<objective>
Add simulated social presence (friend avatars with movement, Ghost Mode toggle) and POI markers to the map, then polish the full app for demo readiness with no broken or empty states.

Purpose: This is the final phase. The demo must look alive with social activity on the map and feel polished for the hackathon presentation tomorrow.
Output: js/social.js (new), updated index.html, css/style.css, js/app.js
</objective>

<execution_context>
@C:\Users\Admin\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Admin\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@index.html
@js/app.js
@js/ai.js
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expose map globally and create social layer with friend avatars, Ghost Mode, and POI markers</name>
  <files>js/app.js, js/social.js, css/style.css, index.html</files>
  <action>
**Step 1: Expose the Leaflet map instance (js/app.js)**

In the first IIFE of app.js, after the map is created (line ~28 `var map = L.map('map', ...)`), add:
```
window.geoMap = map;
```
This allows social.js to access the map for adding markers. Do NOT restructure the IIFE or change any other code.

**Step 2: Add Ghost Mode toggle button to index.html**

Add a Ghost Mode toggle button AFTER the status-pill div and BEFORE the content-panel div:
```html
<button id="ghost-toggle" class="ghost-toggle" aria-label="Toggle Ghost Mode">
  <span class="ghost-toggle__icon">üëª</span>
  <span class="ghost-toggle__label">Ghost Mode</span>
</button>
```

Add the social.js script tag AFTER the ai.js script tag:
```html
<script src="js/social.js"></script>
```

**Step 3: Create js/social.js**

Create a new IIFE following the same pattern as app.js and ai.js (ES5, .then() chains, no async/await, no ES modules). The file should contain:

**Friend Avatar Data** ‚Äî Hardcoded array of 4-5 simulated friends near DEFAULT_CENTER (Tel Aviv: 32.0853, 34.7818). Each friend has: name, lat, lng, avatar emoji. Example friends:
- { name: 'Maya', lat: 32.0863, lng: 34.7828, emoji: 'üßë‚Äçüé®' }
- { name: 'Ori', lat: 32.0843, lng: 34.7808, emoji: 'üé∏' }
- { name: 'Noa', lat: 32.0873, lng: 34.7798, emoji: 'üì∏' }
- { name: 'Amit', lat: 32.0833, lng: 34.7838, emoji: 'üèÉ' }

**Friend Markers** ‚Äî For each friend, create a Leaflet marker using L.divIcon with class 'friend-marker'. The div icon HTML should show the emoji and name label. Add all markers to a Leaflet LayerGroup stored in a variable (e.g., `friendsLayer`). Add the layer group to `window.geoMap`.

**Movement Animation** ‚Äî Use setInterval (every 3000ms) to gently drift each friend marker by a small random offset (e.g., +/- 0.0002 in lat/lng). This creates a subtle "walking around" effect. Store the interval ID so it can be cleared.

**Ghost Mode** ‚Äî Add a click listener on `#ghost-toggle`. When clicked:
- Toggle a CSS class `ghost-toggle--active` on the button
- If active: remove friendsLayer from the map (`window.geoMap.removeLayer(friendsLayer)`)
- If inactive: add friendsLayer back (`window.geoMap.addLayer(friendsLayer)`)
- Ghost mode does NOT affect POI markers, only friend avatars

**POI Markers** ‚Äî Hardcoded array of 5-6 points of interest near DEFAULT_CENTER. Each POI has: name, lat, lng, type (e.g., 'museum', 'ruins', 'park', 'temple', 'market'). Use L.circleMarker (radius 6, theme-accent color, fillOpacity 0.7) for POIs. Bind a tooltip with the POI name. Add POIs to a separate LayerGroup added to the map.

**Step 4: Add CSS styles (css/style.css)**

Append the following styles to the end of style.css (BEFORE the responsive media queries):

**Friend marker styles:**
- `.friend-marker`: display flex, flex-direction column, align-items center, pointer-events none
- `.friend-marker__emoji`: font-size 24px, filter drop-shadow with neon-cyan glow
- `.friend-marker__name`: font-size 10px, color white, background rgba(10,10,15,0.8), padding 2px 6px, border-radius 4px, white-space nowrap, font-family var(--font-body), margin-top 2px

**Ghost Mode toggle:**
- `.ghost-toggle`: position fixed, top calc(var(--header-height) + 12px), right 12px, z-index 1100, background rgba(18,18,26,0.85), backdrop-filter blur(10px), border 1px solid rgba(139,92,246,0.25), border-radius 12px, padding 8px 14px, cursor pointer, display flex, align-items center, gap 6px, transition all 0.3s ease, color var(--text-secondary), font-size 12px, font-family var(--font-body)
- `.ghost-toggle:hover`: background rgba(255,255,255,0.08)
- `.ghost-toggle--active`: background rgba(139,92,246,0.2), border-color rgba(139,92,246,0.5), color var(--text-primary)
- `.ghost-toggle--active .ghost-toggle__icon`: opacity 0.5 (to visually indicate "hidden")
- `.ghost-toggle__icon`: font-size 16px, line-height 1
- `.ghost-toggle__label`: text-transform uppercase, letter-spacing 0.05em

**POI tooltip override** (make Leaflet tooltips match dark theme):
- `.leaflet-tooltip`: background rgba(18,18,26,0.9) !important, color var(--text-primary) !important, border 1px solid rgba(var(--theme-accent-rgb),0.3) !important, border-radius 6px !important, font-family var(--font-body) !important, font-size 11px !important, padding 4px 8px !important
- `.leaflet-tooltip-top::before`: border-top-color rgba(18,18,26,0.9) !important
- `.leaflet-tooltip-bottom::before`: border-bottom-color rgba(18,18,26,0.9) !important

Add responsive adjustments in the existing `@media (max-width: 480px)` block:
- `.ghost-toggle`: top calc(var(--header-height) + 8px), right 8px, padding 6px 10px, font-size 11px
  </action>
  <verify>
1. Open the app in browser ‚Äî friend avatars (emoji + name) should be visible on the map near Tel Aviv
2. Avatars should drift slightly every 3 seconds
3. Clicking "Ghost Mode" button hides all friend markers; clicking again shows them
4. Circle POI markers visible on map with tooltips on hover
5. No console errors
  </verify>
  <done>
- 4 friend avatars visible on map with emoji icons and name labels
- Friends drift position every 3 seconds with gentle movement
- Ghost Mode toggle hides/shows friend markers (not POI markers)
- 5-6 POI circle markers visible with name tooltips
- Ghost toggle button styled in top-right corner matching dark theme
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end demo polish ‚Äî fix empty states and visual gaps</name>
  <files>js/social.js, js/ai.js, css/style.css, index.html</files>
  <action>
Review the full app flow and fix any broken or empty states visible during a demo walkthrough:

**1. Content panel auto-open on load:** The content panel opens automatically after 1 second (ai.js line 167-169). Verify this still works with the new social layer. If the panel obscures friend avatars on mobile, ensure the content panel close button is obvious and accessible.

**2. GPS fallback polish:** When GPS is unavailable, the app shows "GPS unavailable ‚Äî showing Tel Aviv". The friend avatars and POIs should be positioned around the DEFAULT_CENTER (Tel Aviv) so they are visible regardless of GPS status. Verify the friends and POIs appear at the default center, not at the user's actual GPS position (since the hardcoded data is around Tel Aviv).

**3. Empty state for content panel:** If the user closes the content panel and has no way to reopen it, add a small floating button (bottom-right, above the status pill) that reopens the content panel. In css/style.css add:
- `.content-reopen`: position fixed, bottom 100px, right 16px, z-index 1100, width 44px, height 44px, border-radius 50%, background rgba(18,18,26,0.85), backdrop-filter blur(10px), border 1px solid rgba(var(--theme-accent-rgb),0.3), color var(--theme-accent), font-size 20px, cursor pointer, display flex (hidden by default when panel is open)
- `.content-reopen:hover`: background rgba(var(--theme-accent-rgb),0.15)

In js/ai.js (or js/social.js to avoid touching ai.js): Add logic to show the reopen button when the panel is closed and hide it when the panel is open. The button text/icon can be a simple "üìñ" or "‚â°" character. Add the button element to index.html.

**4. Leaflet zoom controls position:** The default Leaflet zoom controls may overlap with the time-axis. In css/style.css, add:
- `.leaflet-control-zoom`: position absolute, top 10px, right 10px (move to top-right to avoid conflict with time-axis on left). Actually Leaflet zoom is already top-left by default. Move it: `.leaflet-top.leaflet-left { top: auto; bottom: 110px; }` to push it above the category bar, or just leave it if it does not overlap. Check visually and only adjust if needed.

**5. Mobile touch targets:** Ensure all buttons (time-axis, category-bar, ghost toggle, close buttons) have minimum 44px touch targets on mobile. The existing styles should handle this but verify padding values in the 480px media query.

**6. No JavaScript errors:** Ensure social.js handles the case where window.geoMap might not be ready yet. Wrap the initialization in a check: `if (!window.geoMap) { console.warn('Map not ready'); return; }` at the top of the social.js IIFE.

Do NOT change the hardcoded content database in ai.js. Do NOT change the navigator interaction logic in app.js beyond exposing window.geoMap.
  </action>
  <verify>
1. Full walkthrough: Open app -> map loads -> content panel opens with content -> close panel -> reopen button appears -> click reopen -> panel slides back in
2. Friend avatars visible and moving on map
3. Ghost Mode toggle works
4. POI markers visible with tooltips
5. No console errors at any point
6. On mobile viewport (Chrome DevTools device mode): all buttons tappable, no overlapping UI elements, content panel covers full width
  </verify>
  <done>
- No empty or broken states visible during a full demo walkthrough
- Content panel can be reopened after closing
- All UI elements properly layered with no overlaps
- App works on both mobile and desktop viewports
- Zero console errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 4: Social map layer with friend avatars, Ghost Mode toggle, POI markers, and end-to-end demo polish. The app should now be presentation-ready for the hackathon.</what-built>
  <how-to-verify>
1. Open the app in browser (http://localhost:5173 or your dev server)
2. Verify friend avatars (emoji + name) appear on map near Tel Aviv
3. Watch for 10 seconds ‚Äî avatars should drift slightly
4. Click "Ghost Mode" button (top-right) ‚Äî all friend avatars should disappear
5. Click "Ghost Mode" again ‚Äî avatars reappear
6. Verify POI circle markers visible on map ‚Äî hover to see tooltips
7. Close the content panel ‚Äî a reopen button should appear
8. Click the reopen button ‚Äî content panel slides back in
9. Switch time periods and categories ‚Äî content updates, theme colors change
10. Open Chrome DevTools -> Toggle device toolbar -> Select iPhone SE or similar
11. Verify mobile layout: no overlapping elements, all buttons tappable
12. Check console for errors (should be zero)
  </how-to-verify>
  <resume-signal>Type "approved" if demo-ready, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] Friend avatars visible on map with names
- [ ] Avatars animate (drift) over time
- [ ] Ghost Mode toggle hides/shows friends
- [ ] POI markers visible with tooltips
- [ ] Content panel reopenable after close
- [ ] No empty states during demo flow
- [ ] Works on mobile viewport
- [ ] Zero console errors
</verification>

<success_criteria>
The app is demo-ready for hackathon presentation: social presence on map feels alive, Ghost Mode toggle works visually, POI markers add map richness, and a full walkthrough from open-to-explore has no broken or empty states on both phone and desktop browser.
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-social/04-01-SUMMARY.md`
</output>
